<h1 id="EQ9xy">å®ç°ç®€å•ç‰ˆrpcæ¡†æ¶</h1>
<h2 id="o3Gjv">é¡¹ç›®åˆå§‹åŒ–</h2>
<h3 id="k2gEb">ç®€å•ç‰ˆéœ€è¦çš„æ¨¡å—</h3>
| æ¨¡å—åç§° | ä½œç”¨ |
| --- | --- |
| example-common | å°†å®ä½“ç±»å’Œæ¥å£å†™åˆ°è¿™é‡Œè¾¹ï¼Œæä¾›è€…å’Œæ¶ˆè´¹è€…å¯ä»¥ä¾èµ–ï¼Œä¸ç”¨åˆ†åˆ«å†™ä¸¤æ¬¡ |
| example-provider | æœåŠ¡æä¾›è€…ï¼Œå†™æœåŠ¡å…·ä½“çš„å®ç°ï¼Œ |
| example-consumer | æœåŠ¡æ¶ˆè´¹è€… |
| rpc-easy | ç®€å•ç‰ˆçš„rpcï¼Œé€šä¿¡åè®®ï¼Œä¸»è¦å®ç°æœåŠ¡çš„æ³¨å†Œï¼Œåºåˆ—åŒ–å’Œè¿”åºåˆ—åŒ–ï¼Œè¯·æ±‚å’Œå“åº”å¤„ç† |


<h4 id="d3p8H">example-common</h4>
Userç±»ï¼Œå®ç°åºåˆ—åŒ–æ¥å£

UserServiceæ¥å£

ä½œç”¨æ˜¯ä¸¤è€…ä¾èµ–åå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä¸ç”¨åˆ†åˆ«å†™äº†ã€‚çœŸå®æƒ…å†µä¸‹ä¸èƒ½æœ‰commonï¼Œéœ€è¦åˆ†åˆ«å®ç°

<h4 id="KI4Uo">example-provider</h4>
å¼•å…¥commonå’Œrpc-easy

å®ç°UserServiceæ¥å£

<h4 id="yocQt">example-consumer</h4>
æ¶ˆè´¹æœåŠ¡

<h5 id="kQo2K">ä»£ç†</h5>
<h6 id="dTN39">é™æ€ä»£ç†</h6>
é™æ€ä»£ç†å¾ˆå¥½ç†è§£ï¼Œå®ç°æ–¹å¼æ˜¯å®ç°UserServiceæ¥å£ï¼ŒUserServiceProxyä»£ç†ç±»ï¼Œå°†å¤„ç†é€»è¾‘å†™åˆ°å®ç°ç±»é‡Œï¼Œç±»ä¼¼äºå°±æ˜¯UserServiceImplæ–¹å¼ã€‚è¿™ç§æ–¹å¼æ¯æ¬¡éœ€è¦è°ƒç”¨ä¸€ä¸ªæ–°çš„æœåŠ¡ï¼Œéƒ½éœ€è¦æ–°å†™ä¸€ä¸ªå®ç°ç±»ã€‚ä¸è¡ŒğŸ™…â€â™€ï¸

```java
package com.yupi.example.consumer;

import cn.hutool.http.HttpRequest;
import cn.hutool.http.HttpResponse;
import com.yupi.example.common.model.User;
import com.yupi.example.common.service.UserService;
import com.yupi.yurpc.model.RpcRequest;
import com.yupi.yurpc.model.RpcResponse;
import com.yupi.yurpc.serializer.JdkSerializer;
import com.yupi.yurpc.serializer.Serializer;

import java.io.IOException;

/**
 * é™æ€ä»£ç†
 */
public class UserServiceProxy implements UserService {

    public User getUser(User user) {
        // æŒ‡å®šåºåˆ—åŒ–å™¨
        Serializer serializer = new JdkSerializer();

        // å‘è¯·æ±‚
        RpcRequest rpcRequest = RpcRequest.builder()
                .serviceName(UserService.class.getName())
                .methodName("getUser")
                .parameterTypes(new Class[]{User.class})
                .args(new Object[]{user})
                .build();
        try {
            byte[] bodyBytes = serializer.serialize(rpcRequest);
            byte[] result;
            try (HttpResponse httpResponse = HttpRequest.post("http://localhost:8080")
                    .body(bodyBytes)
                    .execute()) {
                result = httpResponse.bodyBytes();
            }
            RpcResponse rpcResponse = serializer.deserialize(result, RpcResponse.class);
            return (User) rpcResponse.getData();
        } catch (IOException e) {
            e.printStackTrace();
        }
        return null;
    }
}

```

<h6 id="pnGgW">åŠ¨æ€ä»£ç†*</h6>
åŠ¨æ€ä»£ç†åˆ†ä¸ºJDKåŠ¨æ€ä»£ç†å’ŒCGLIBåŠ¨æ€ä»£ç†ã€‚ä½¿ç”¨JDKåŠ¨æ€ä»£ç†

```java
package com.yupi.yurpc.proxy;

import cn.hutool.http.HttpRequest;
import cn.hutool.http.HttpResponse;
import com.yupi.yurpc.model.RpcRequest;
import com.yupi.yurpc.model.RpcResponse;
import com.yupi.yurpc.serializer.JdkSerializer;
import com.yupi.yurpc.serializer.Serializer;

import java.io.IOException;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;

/**
 * æœåŠ¡ä»£ç†ï¼ˆJDK åŠ¨æ€ä»£ç†ï¼‰
 */
public class ServiceProxy implements InvocationHandler {

    /**
     * è°ƒç”¨ä»£ç†
     *
     * @return
     * @throws Throwable
     */
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        // æŒ‡å®šåºåˆ—åŒ–å™¨
        Serializer serializer = new JdkSerializer();

        // æ„é€ è¯·æ±‚
        RpcRequest rpcRequest = RpcRequest.builder()
                .serviceName(method.getDeclaringClass().getName())
                .methodName(method.getName())
                .parameterTypes(method.getParameterTypes())
                .args(args)
                .build();
        try {
            // åºåˆ—åŒ–
            byte[] bodyBytes = serializer.serialize(rpcRequest);
            // å‘é€è¯·æ±‚
            // todo æ³¨æ„ï¼Œè¿™é‡Œåœ°å€è¢«ç¡¬ç¼–ç äº†ï¼ˆéœ€è¦ä½¿ç”¨æ³¨å†Œä¸­å¿ƒå’ŒæœåŠ¡å‘ç°æœºåˆ¶è§£å†³ï¼‰
            try (HttpResponse httpResponse = HttpRequest.post("http://localhost:8080")
                    .body(bodyBytes)
                    .execute()) {
                byte[] result = httpResponse.bodyBytes();
                // ååºåˆ—åŒ–
                RpcResponse rpcResponse = serializer.deserialize(result, RpcResponse.class);
                return rpcResponse.getData();
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        return null;
    }
}

```

ä»£ç†å¯¹è±¡å·¥å‚ï¼Œç”ŸæˆæŒ‡å®šçš„ä»£ç†å¯¹è±¡

```java
package com.yupi.yurpc.proxy;

import java.lang.reflect.Proxy;

/**
 * æœåŠ¡ä»£ç†å·¥å‚ï¼ˆç”¨äºåˆ›å»ºä»£ç†å¯¹è±¡ï¼‰
 */
public class ServiceProxyFactory {

    /**
     * æ ¹æ®æœåŠ¡ç±»è·å–ä»£ç†å¯¹è±¡
     *
     * @param serviceClass
     * @param <T>
     * @return
     */
    public static <T> T getProxy(Class<T> serviceClass) {
        return (T) Proxy.newProxyInstance(
                serviceClass.getClassLoader(),
                new Class[]{serviceClass},
                new ServiceProxy());
    }
}

```

:::info
<font style="color:#DF2A3F;">å¤„ç†æµç¨‹</font>

1. <font style="color:#DF2A3F;">å½“æ¶ˆè´¹è€…æ‰§è¡ŒUserService userService = ServiceProxyFactory.getProxy(UserService.class);ä»£ç æ—¶ï¼Œuserserviceå¯¹è±¡æ˜¯userserviceproxyåŠ¨æ€ä»£ç†å¯¹è±¡ï¼›</font>
2. <font style="color:#DF2A3F;">å½“æ‰§è¡ŒuserService.getUseræ—¶ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ—¶userserviceproxyä¸­çš„invokeæ–¹æ³•</font>

:::

<h4 id="SDVUs">rpc-easy</h4>
<h5 id="V8xOv">å®ç°webæœåŠ¡</h5>
æœåŠ¡æä¾›è€…å¼•ç”¨åï¼Œå¼€å¯webæœåŠ¡

é¦–å…ˆæ˜¯httpæœåŠ¡æ¥å£ï¼Œå®šä¹‰æ–¹æ³•ã€‚åç»­å®ç°ä¸åŒçš„webæœåŠ¡éƒ½éœ€è¦å®ç°æ­¤æ¥å£

```java
package com.yupi.yurpc.server;

/**
 * HTTP æœåŠ¡å™¨æ¥å£
 */
public interface HttpServer {

    /**
     * å¯åŠ¨æœåŠ¡å™¨
     *
     * @param port
     */
    void doStart(int port);
}

```

httpæœåŠ¡å®ç°

```java
package com.yupi.yurpc.server;

import io.vertx.core.Vertx;

public class VertxHttpServer implements HttpServer {

    public void doStart(int port) {
        // åˆ›å»º Vert.x å®ä¾‹
        Vertx vertx = Vertx.vertx();

        // åˆ›å»º HTTP æœåŠ¡å™¨
        io.vertx.core.http.HttpServer server = vertx.createHttpServer();

        // ç›‘å¬ç«¯å£å¹¶å¤„ç†è¯·æ±‚
        server.requestHandler(request -> {
            // å¤„ç† HTTP è¯·æ±‚
            System.out.println("Received request: " + request.method() + " " + request.uri());

            // å‘é€ HTTP å“åº”
            request.response()
            .putHeader("content-type", "text/plain")
            .end("Hello from Vert.x HTTP server!");
        });

        // å¯åŠ¨ HTTP æœåŠ¡å™¨å¹¶ç›‘å¬æŒ‡å®šç«¯å£
        server.listen(port, result -> {
            if (result.succeeded()) {
                System.out.println("Server is now listening on port " + port);
            } else {
                System.err.println("Failed to start server: " + result.cause());
            }
        });
    }
}

```

<h5 id="MPiCA">æœ¬åœ°æ³¨å†Œå™¨*</h5>
ä½¿ç”¨concurrenthashmapå®ç°

```java
package com.yupi.yurpc.registry;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * æœ¬åœ°æ³¨å†Œä¸­å¿ƒ
 */
public class LocalRegistry {

    /**
     * æ³¨å†Œä¿¡æ¯å­˜å‚¨
     */
    private static final Map<String, Class<?>> map = new ConcurrentHashMap<>();

    /**
     * æ³¨å†ŒæœåŠ¡
     *
     * @param serviceName
     * @param implClass
     */
    public static void register(String serviceName, Class<?> implClass) {
        map.put(serviceName, implClass);
    }

    /**
     * è·å–æœåŠ¡
     *
     * @param serviceName
     * @return
     */
    public static Class<?> get(String serviceName) {
        return map.get(serviceName);
    }

    /**
     * åˆ é™¤æœåŠ¡
     *
     * @param serviceName
     */
    public static void remove(String serviceName) {
        map.remove(serviceName);
    }
}

```

:::info
<u><font style="color:#DF2A3F;">æ³¨ï¼šæœ¬åœ°æ³¨å†Œå™¨å’Œæ³¨å†Œä¸­å¿ƒæ˜¯æœ‰åŒºåˆ«çš„ï¼Œä½œç”¨æ˜¯ä¸ç›¸åŒçš„ã€‚æ³¨å†Œä¸­å¿ƒçš„ä½œç”¨æ˜¯ç®¡ç†æœåŠ¡ä¿¡æ¯ï¼Œå°†æœåŠ¡ä¿¡æ¯æä¾›ç»™æ¶ˆè´¹è€…ã€‚æœ¬åœ°æ³¨å†Œä¸­å¿ƒä½œç”¨æ˜¯æ ¹æ®æœåŠ¡åç§°è·å–å®ç°ç±»Class</font></u>

:::

<h5 id="TTITR"><font style="color:#000000;">åºåˆ—åŒ–å™¨</font></h5>
åºåˆ—åŒ–ï¼šå°†javaå¯¹è±¡è½¬æ¢æˆå¯ä¼ è¾“çš„å­—èŠ‚æ•°ç»„ã€‚

è¿”åºåˆ—åŒ–ï¼šå°†å¯ä¼ è¾“çš„å­—èŠ‚æ•°ç»„è½¬åŒ–æˆjavaå¯¹è±¡

```java
package com.yupi.yurpc.serializer;

import java.io.IOException;

/**
 * åºåˆ—åŒ–å™¨æ¥å£
 */
public interface Serializer {

    /**
     * åºåˆ—åŒ–
     *
     * @param object
     * @param <T>
     * @return
     * @throws IOException
     */
    <T> byte[] serialize(T object) throws IOException;

    /**
     * ååºåˆ—åŒ–
     *
     * @param bytes
     * @param type
     * @param <T>
     * @return
     * @throws IOException
     */
    <T> T deserialize(byte[] bytes, Class<T> type) throws IOException;
}
```

```java
package com.yupi.yurpc.serializer;

import java.io.*;

/**
 * JDK åºåˆ—åŒ–å™¨
 */
public class JdkSerializer implements Serializer {

    /**
     * åºåˆ—åŒ–
     *
     * @param object
     * @param <T>
     * @return
     * @throws IOException
     */
    @Override
    public <T> byte[] serialize(T object) throws IOException {
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(outputStream);
        objectOutputStream.writeObject(object);
        objectOutputStream.close();
        return outputStream.toByteArray();
    }

    /**
     * ååºåˆ—åŒ–
     *
     * @param bytes
     * @param type
     * @param <T>
     * @return
     * @throws IOException
     */
    @Override
    public <T> T deserialize(byte[] bytes, Class<T> type) throws IOException {
        ByteArrayInputStream inputStream = new ByteArrayInputStream(bytes);
        ObjectInputStream objectInputStream = new ObjectInputStream(inputStream);
        try {
            return (T) objectInputStream.readObject();
        } catch (ClassNotFoundException e) {
            throw new RuntimeException(e);
        } finally {
            objectInputStream.close();
        }
    }
}
```

<h5 id="taUOP">è¯·æ±‚å¤„ç†å™¨</h5>
å¤„ç†æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œæ ¹æ®è·å–åˆ°çš„å‚æ•°æ‰¾åˆ°å¯¹åº”çš„æœåŠ¡å’Œæ–¹æ³•ï¼Œé€šè¿‡åå°„è°ƒç”¨å®ç°ï¼Œå°è£…è¿”å›ç»“æœå¹¶å¤„ç†å“åº”ã€‚

```java
package com.yupi.yurpc.model;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.io.Serializable;

/**
 * RPC è¯·æ±‚
 */
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class RpcRequest implements Serializable {

    /**
     * æœåŠ¡åç§°
     */
    private String serviceName;

    /**
     * æ–¹æ³•åç§°
     */
    private String methodName;

    /**
     * å‚æ•°ç±»å‹åˆ—è¡¨
     */
    private Class<?>[] parameterTypes;

    /**
     * å‚æ•°åˆ—è¡¨
     */
    private Object[] args;

}

```

```java
package com.yupi.yurpc.model;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.io.Serializable;

/**
 * RPC å“åº”
 */
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class RpcResponse implements Serializable {

    /**
     * å“åº”æ•°æ®
     */
    private Object data;

    /**
     * å“åº”æ•°æ®ç±»å‹ï¼ˆé¢„ç•™ï¼‰
     */
    private Class<?> dataType;

    /**
     * å“åº”ä¿¡æ¯
     */
    private String message;

    /**
     * å¼‚å¸¸ä¿¡æ¯
     */
    private Exception exception;

}

```

ç¼–å†™HttpServerHandler

1. å°†ä¼ è¾“è¿‡æ¥çš„å­—èŠ‚ç æ•°ç»„è¿”åºåˆ—åŒ–ä¸ºjavaå¯¹è±¡
2. ä»javaå¯¹è±¡è·å–åˆ°çš„å‚æ•°ï¼Œè°ƒç”¨æä¾›è€…æ–¹æ³•
3. å¤„ç†ç»“æœï¼Œå°è£…ä¸ºå“åº”ç»“æœï¼Œå“åº”

```java
package com.yupi.yurpc.server;

import com.yupi.yurpc.model.RpcRequest;
import com.yupi.yurpc.model.RpcResponse;
import com.yupi.yurpc.registry.LocalRegistry;
import com.yupi.yurpc.serializer.JdkSerializer;
import com.yupi.yurpc.serializer.Serializer;
import io.vertx.core.Handler;
import io.vertx.core.buffer.Buffer;
import io.vertx.core.http.HttpServerRequest;
import io.vertx.core.http.HttpServerResponse;

import java.io.IOException;
import java.lang.reflect.Method;

/**
 * HTTP è¯·æ±‚å¤„ç†
 */
public class HttpServerHandler implements Handler<HttpServerRequest> {

    @Override
    public void handle(HttpServerRequest request) {
        // æŒ‡å®šåºåˆ—åŒ–å™¨
        final Serializer serializer = new JdkSerializer();

        // è®°å½•æ—¥å¿—
        System.out.println("Received request: " + request.method() + " " + request.uri());

        // å¼‚æ­¥å¤„ç† HTTP è¯·æ±‚
        request.bodyHandler(body -> {
            byte[] bytes = body.getBytes();
            RpcRequest rpcRequest = null;
            try {
                rpcRequest = serializer.deserialize(bytes, RpcRequest.class);
            } catch (Exception e) {
                e.printStackTrace();
            }

            // æ„é€ å“åº”ç»“æœå¯¹è±¡
            RpcResponse rpcResponse = new RpcResponse();
            // å¦‚æœè¯·æ±‚ä¸º nullï¼Œç›´æ¥è¿”å›
            if (rpcRequest == null) {
                rpcResponse.setMessage("rpcRequest is null");
                doResponse(request, rpcResponse, serializer);
                return;
            }

            try {
                // è·å–è¦è°ƒç”¨çš„æœåŠ¡å®ç°ç±»ï¼Œé€šè¿‡åå°„è°ƒç”¨
                Class<?> implClass = LocalRegistry.get(rpcRequest.getServiceName());
                Method method = implClass.getMethod(rpcRequest.getMethodName(), rpcRequest.getParameterTypes());
                Object result = method.invoke(implClass.newInstance(), rpcRequest.getArgs());
                // å°è£…è¿”å›ç»“æœ
                rpcResponse.setData(result);
                rpcResponse.setDataType(method.getReturnType());
                rpcResponse.setMessage("ok");
            } catch (Exception e) {
                e.printStackTrace();
                rpcResponse.setMessage(e.getMessage());
                rpcResponse.setException(e);
            }
            // å“åº”
            doResponse(request, rpcResponse, serializer);
        });
    }

    /**
     * å“åº”
     *
     * @param request
     * @param rpcResponse
     * @param serializer
     */
    void doResponse(HttpServerRequest request, RpcResponse rpcResponse, Serializer serializer) {
        HttpServerResponse httpServerResponse = request.response()
                .putHeader("content-type", "application/json");
        try {
            // åºåˆ—åŒ–
            byte[] serialized = serializer.serialize(rpcResponse);
            httpServerResponse.end(Buffer.buffer(serialized));
        } catch (IOException e) {
            e.printStackTrace();
            httpServerResponse.end(Buffer.buffer());
        }
    }
}

```

ä¿®æ”¹httpæœåŠ¡å®ç°ï¼Œè°ƒç”¨httpserverhandler

```java
package com.yupi.yurpc.server;

import io.vertx.core.Vertx;

/**
 * Vertx HTTP æœåŠ¡å™¨
 */
public class VertxHttpServer implements HttpServer {

    /**
     * å¯åŠ¨æœåŠ¡å™¨
     *
     * @param port
     */
    public void doStart(int port) {
        // åˆ›å»º Vert.x å®ä¾‹
        Vertx vertx = Vertx.vertx();

        // åˆ›å»º HTTP æœåŠ¡å™¨
        io.vertx.core.http.HttpServer server = vertx.createHttpServer();

        // ç›‘å¬ç«¯å£å¹¶å¤„ç†è¯·æ±‚
        server.requestHandler(new HttpServerHandler());

        // å¯åŠ¨ HTTP æœåŠ¡å™¨å¹¶ç›‘å¬æŒ‡å®šç«¯å£
        server.listen(port, result -> {
            if (result.succeeded()) {
                System.out.println("Server is now listening on port " + port);
            } else {
                System.err.println("Failed to start server: " + result.cause());
            }
        });
    }
}

```



